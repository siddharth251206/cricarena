{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
  <title>Quiz Results</title>
  <link rel="stylesheet" href="{% static 'quiz/result.css' %}" />
</head>
<body>

  {% include 'quiz/navbar.html' %}
  {% if unlocked_achievements %}
  <div id="achievement-toast" class="toast-container">
    <div class="toast-icon">
      <svg class="checkmark" viewBox="0 0 52 52">
        <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />
        <path class="checkmark-check" fill="none" d="M14 27l7 7 17-17"/>
      </svg>
    </div>
    <div class="toast-text">
      <strong>New Achievement Unlocked</strong>
      {% if unlocked_achievements|length == 1 %}
        <div>{{ unlocked_achievements.0 }}</div>
      {% elif unlocked_achievements|length > 1 %}
        <ul>
          {% for ach in unlocked_achievements %}
            <li>{{ ach }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  </div>
{% endif %}

  <div class="result-page-layout">
  <div class="result-left">
  <div class="results-container">

    <!-- Timer (Optional) -->
    {% if time_taken %}
    <div class="timer-box">
      Time Taken: {{ time_taken }}
    </div>
    {% endif %}

    <!-- Main Heading -->
    <h1>Your Quiz Results</h1>

    <!-- Score Display -->
    <div class="score-display">{{ score }}</div>
    <div class="total-questions">out of 10</div>

    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Performance Message -->
    <div class="message">
      {% if percentage >= 80 %}
        Excellent! You're a cricket expert!
      {% elif percentage >= 60 %}
        Good job! You know your cricket!
      {% elif percentage >= 40 %}
        Not bad! Keep learning about cricket!
      {% else %}
        Keep practicing! You'll improve!
      {% endif %}
    </div>

    <!-- Try Again Button -->
    <a href="{% url 'cricket_quiz' %}" class="retry-btn" data-page="Quiz">Try Again</a>
    <a href="{% url 'poll_list' %}" class="explore-polls" data-page="Fan Polls">🗳️ Explore Fan Polls</a>


    <!-- Detailed Stats Analysis -->
    <div class="detailed-analysis">
      <h2>Performance Breakdown</h2>
      <ul>
        <li><strong>Difficulty:</strong> {{ selected_difficulty|capfirst }}</li>
        <li><strong>Correct Answers:</strong> {{ correct_answers }}</li>
        <li><strong>Wrong Answers:</strong> {{ wrong_answers }}</li>
        <li><strong>Accuracy:</strong> {{ percentage }}%</li>
        <li><strong>Performance Level:</strong> {{ performance_level }}</li>
        {% if time_taken %}
        <li><strong>Time Taken:</strong> {{ time_taken }}</li>
        {% endif %}
      </ul>

      <div class="suggestions">
        <h3>Suggestions</h3>
        <p>
          {% if percentage >= 90 %}
            You’re unstoppable! Maybe write your own quiz next?
          {% elif percentage >= 75 %}
            Solid game! A little more polish and you’re there.
          {% elif percentage >= 50 %}
            Decent effort! Go binge some cricket stats now.
          {% else %}
            Don’t worry champ — practice and redemption await.
          {% endif %}
        </p>
      </div>
    </div>

    <!-- Answered Questions -->
    <div class="answered-results">
      {% for result in results %}
      <div class="question-card">
        <div class="question-text">{{ forloop.counter }}. {{ result.question }}</div>
        <div>
          Your answer:
          <span class="{% if result.is_correct %}correct-answer{% else %}incorrect-answer{% endif %}">
            {{ result.user_answer|default:"No answer" }}
          </span>
        </div>
        {% if not result.is_correct %}
        <div>
          Correct answer:
          <span class="correct-answer">{{ result.correct_answer }}</span>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div></div>
   <div class="right-panel">
    <div class="leaderboard-block">
      <h2 style="margin-bottom: 10px;">🏆 Top 5 on Leaderboard</h2>
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>User</th>
            <th>Rating</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in leaderboard|slice:":5" %}
          <tr>
            <td>
              {% if forloop.counter0 == 0 %} 🥇
              {% elif forloop.counter0 == 1 %} 🥈
              {% elif forloop.counter0 == 2 %} 🥉
              {% else %} {{ forloop.counter }}
              {% endif %}
            </td>
            <td class="user-cell">
  {% if entry.user.avatar %}
    <img src="{{ entry.user.avatar.url }}" alt="Avatar" class="avatar-img-leaderboard">
  {% else %}
    <span class="avatar-fallback-leaderboard">{{ entry.user.nickname|default:entry.user.username|slice:":1"|upper }}</span>
  {% endif %}
  <span class="username-text">{{ entry.user.nickname|default:entry.user.username }}</span>
</td>
            <td>{{ entry.average_rating|floatformat:2 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <a href="{% url 'leaderboard' %}" class="view-full-btn" data-page="Leaderboard">View Full Leaderboard →</a>
    </div>

<div class="review-box">
  <h2>📝 Share Your Thoughts</h2>

  <form method="post" action="{% url 'submit_review' %}">
    {% csrf_token %}

    <label for="review_type">Review For:</label>
    <select name="review_type" id="review_type" required>
      <option value="quiz">This Quiz</option>
      <option value="site">The Whole Site</option>
      <option value="both">Both</option>
    </select>

    <label for="rating">Your Rating:</label>
    <div class="rating-options">
      <label><input type="radio" name="rating" value="5"> 😍</label>
      <label><input type="radio" name="rating" value="4"> 😀</label>
      <label><input type="radio" name="rating" value="3"> 😐</label>
      <label><input type="radio" name="rating" value="2"> 😕</label>
      <label><input type="radio" name="rating" value="1"> 😡</label>
    </div>

    <label for="feedback">Feedback:</label>
    <textarea name="feedback" id="feedback" rows="4" placeholder="What did you like? What could be better?" required></textarea>

    <button type="submit">Submit Review</button>
  </form>
</div>

  </div></div>
   <div id="page-loader" class="hide"> <!-- start hidden off-screen right -->
  <div class="loader-content">
    <div class="logo-container">
      <img src="/static/ipl/assets/cricarenalogo.png" alt="CRICARENA Logo" class="loader-logo">

      <div class="orbit orbit1"><div class="orbit-ball"></div></div>
      <div class="orbit orbit2"><div class="orbit-ball"></div></div>
      <div class="orbit orbit3"><div class="orbit-ball"></div></div>
      <div class="orbit orbit4"><div class="orbit-ball"></div></div>
      <div class="orbit orbit5"><div class="orbit-ball"></div></div>
      <div class="orbit orbit6"><div class="orbit-ball"></div></div>
    </div>

    <div class="loader-text">Loading <span id="next-page-name">...</span></div>
  </div>
</div>

 <script>
  document.documentElement.classList.add("js-loader-ready");
</script>
  <!-- Progress Bar Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const progressBar = document.getElementById('progressBar');
      const percentage = parseFloat("{{ percentage|default:0 }}");
      setTimeout(() => {
        progressBar.style.width = percentage + '%';
      }, 100);
  setTimeout(() => {
    const toast = document.getElementById('achievement-toast');
    if (toast) {
      toast.style.transition = 'opacity 0.6s ease';
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 600);
    }
  }, 5000);
  window.history.replaceState(null, "", "/quiz/");

  // If user clicks Back or navigates with back/forward buttons
  window.addEventListener("popstate", function () {
    window.location.href = "/quiz/";
  });

  // Also handle page being restored from cache (e.g. Safari/Firefox back button)
  window.addEventListener("pageshow", function (event) {
    if (event.persisted) {
      window.location.href = "/quiz/";
    }
  });
  const loader = document.getElementById("page-loader");
const nextPageName = document.getElementById("next-page-name");

// Mark page as JS-ready so CSS flex works
document.documentElement.classList.add("js-loader-ready");

// Handle link clicks for forward navigation
document.querySelectorAll("a").forEach(link => {
  if (
    link.hostname === window.location.hostname &&
    link.getAttribute("href") &&
    !link.href.includes("#")
  ) {
    link.addEventListener("click", e => {
      if (e.ctrlKey || e.metaKey || link.target === "_blank") return;

      e.preventDefault();

      // Set loading page name
      const pageName = link.getAttribute("data-page") || link.textContent.trim() || "Loading";
      nextPageName.textContent = pageName;

      // Show loader animation
      loader.classList.remove("hide");
      loader.classList.add("active");

      // Navigate after short delay
      setTimeout(() => {
        window.location.href = link.href;
      }, 500);
    });
  }
});

// On page load
window.addEventListener("load", () => {
  setTimeout(() => {
    loader.classList.add("hide");
    loader.classList.remove("active");
  }, 300);
});

// Detect browser back/forward and disable animation
window.addEventListener("pageshow", (event) => {
  if (
    event.persisted ||
    performance.getEntriesByType("navigation")[0]?.type === "back_forward"
  ) {
    loader.style.transition = "none"; // kill animation
    loader.classList.add("hide");
    loader.classList.remove("active");
    // Restore animation for future forward nav
    requestAnimationFrame(() => {
      loader.style.transition = "";
    });
  }
});

    });
  </script>

</body>
</html>
