{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profile</title>
  <link rel="stylesheet" href="{% static 'accounts/css/profile.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
{% if messages %}
  <div class="toast-container">
    {% for message in messages %}
      <div class="toast-message">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<header class="profile-page-header">
  <a href="{{ back_url }}" class="back-btn" data-skip-loader onclick="clearBack()" aria-label="Go back">
  <i class="fas fa-arrow-left"></i>
</a>
  <h1 class="header-title">My Profile</h1>
</header>

  <div class="profile-wrapper">
  <!-- LEFT PANEL -->
  <aside class="profile-sidebar">
  <div class="profile-card">
    <!-- Avatar -->
    <div class="profile-avatar-img">
  {% if user.avatar %}
    <img src="{{ user.avatar.url }}" alt="Avatar">
  {% else %}
    <span class="avatar-fallback">{{ user.nickname|default:user.username|slice:":1"|upper }}</span>
  {% endif %}
</div>


    <!-- Core Info -->
    <div class="profile-sidebar-info">
      <h2 class="profile-name">{{ user.nickname|default:user.username }}</h2>
      <p class="profile-meta-label"><i class="fas fa-envelope"></i>Email</p>
      <p class="profile-meta-value">{{ user.email }}</p>
      <p class="profile-meta-label">Member Since</p>
      <p class="profile-meta-value">{{ user.date_joined|date:"F Y" }}</p>
    </div>

    <!-- Actions -->
    <div class="profile-actions">
      <a href="javascript:void(0)" class="edit-profile-btn" onclick="toggleModal()"><i class="fas fa-user-edit"></i> Edit Account</a>
      
    </div>
  </div>

  <!-- Divider -->
  <div class="profile-divider"></div>

  <!-- Security Section -->
  <div class="security-box">
    <h3 class="security-title">Security & Session</h3>
    <form method="post" action="{% url 'logout' %}">
      {% csrf_token %}
    <button type="submit" class="logout-link">
      <i class="fas fa-sign-out-alt"></i> Sign Out
    </button> </form>
  </div>
</aside>


  <!-- RIGHT MAIN SECTION -->
  <main class="profile-main">
    <!-- We'll add each section here one-by-one -->
     <section class="profile-section fav-team-section">
  <div class="section-header">
    <h2 class="section-heading">Favorite IPL Team</h2>
  </div>

  <div class="team-box">
    <div class="team-logo">
      <img
        src="{% if fav_team|upper == 'DC' %}
           https://documents.iplt20.com/ipl/DC/Logos/LogoOutline/DCoutline.png
         {% else %}
           https://documents.iplt20.com/ipl/{{ fav_team|upper }}/Logos/Logooutline/{{ fav_team|upper }}outline.png
         {% endif %}"
        alt="{{ fav_team }} logo"
      >
    </div>

    <div class="team-details">
      <p class="team-name">
        {% if fav_team == "CSK" %}Chennai Super Kings
        {% elif fav_team == "MI" %}Mumbai Indians
        {% elif fav_team == "RCB" %}Royal Challengers Bangalore
        {% elif fav_team == "KKR" %}Kolkata Knight Riders
        {% elif fav_team == "RR" %}Rajasthan Royals
        {% elif fav_team == "DC" %}Delhi Capitals
        {% elif fav_team == "LSG" %}Lucknow Super Giants
        {% elif fav_team == "GT" %}Gujarat Titans
        {% elif fav_team == "PBKS" %}Punjab Kings
        {% elif fav_team == "SRH" %}Sunrisers Hyderabad
        {% else %}Not selected
        {% endif %}
      </p>
      <a class="team-link" href="/ipl/?team={{ fav_team|lower }}">View Team Page</a>
    </div>
  </div>

  <form method="POST" action="{% url 'change_fav_team' %}" class="team-form">
    {% csrf_token %}
    <select name="new_team" required class="team-dropdown">
      <option value="">Change Favorite Team</option>
      {% for code, name in IPL_TEAMS %}
        <option value="{{ code }}" {% if user.fav_ipl_team == code %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="team-update-btn">Update</button>
  </form>
</section>
<!-- === Achievements Section === -->
<section class="profile-section achievements-section">
  <div class="section-header">
    <h2 class="section-heading">Achievements</h2>
    <p class="achievement-summary">Unlocked: <strong>{{ total_achievements }}</strong> / 18</p>
  </div>

  {% if achievements %}
    <div class="achievement-grid">
      {% for ua in recent_achievements %}
        <div class="achievement-card">
          <div class="achievement-icon-box">{{ ua.achievement.icon }}</div>
          <div class="achievement-info">
            <h3 class="achievement-title">{{ ua.achievement.name }}</h3>
            <p class="achievement-desc">{{ ua.achievement.description }}</p>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="view-all-wrapper">
      <a href="{% url 'achievements:user_achievements' %}" class="view-all-link" data-page="Your Achievements">View All Achievements</a>
    </div>
  {% else %}
    <p class="no-achievements-msg">No achievements unlocked yet.</p>
  {% endif %}
</section>
<section class="profile-section quiz-section">
  <div class="section-header">
    <h2 class="section-heading"><i class="fas fa-brain"></i>Quiz Performance</h2>
    <div class="quiz-stats-box">
    <div class="quiz-stat-card">
      <p class="quiz-stat-label">Total Quizzes</p>
      <h3 class="quiz-stat-value">{{ total }}</h3>
    </div>
    <div class="quiz-stat-card">
      <p class="quiz-stat-label">Average Score</p>
      <h3 class="quiz-stat-value">{{ avg_score }}/10</h3>
    </div>
    <div class="quiz-stat-card">
      <p class="quiz-stat-label">Best Score</p>
      <h3 class="quiz-stat-value">{{ max_score }}/10</h3>
    </div>
  </div>
  </div>

  <div class="quiz-scroll-box">
  <div class="quiz-scroll">
    {% for q in quizzes %}
      <div class="quiz-card">
        <div class="quiz-meta">
          <div class="quiz-id">
            {% cycle 'Brainwave' 'Mindstorm' 'QuizWhiz' 'The Grind' 'Curiosity Mode' 'Lightning Round' %}
          </div>
          <div class="quiz-date">
            {{ q.attempted_at|date:"M d, Y Â· h:i A" }}
          </div>
        </div>
        <div class="quiz-stats">
          <div><span>Score:</span> {{ q.score }}/10</div>
          <div><span>Difficulty:</span> {{ q.difficulty|default:"N/A" }}</div>
          <div><span>Time Taken:</span> {{ q.formatted_time_taken }}</div>
        </div>
      </div>
    {% empty %}
      <div class="quiz-card">No quizzes taken yet.</div>
    {% endfor %}
  </div>
</div>

</section>

<section class="profile-section fan-wall-section">
  <h2 class="section-heading">Fan Wall</h2>

  {% comment %} <form method="POST" action="" class="fan-wall-form">
    {% csrf_token %}
    <textarea
      name="message"
      class="fan-wall-input"
      placeholder="Write your message to the community..."
      rows="3"
      required
    ></textarea>
    <button type="submit" class="fan-wall-btn">Post Message</button>
  </form> {% endcomment %}

  <form method="POST" action="{% url 'blogpage' %}" class="fan-wall-form">
  {% csrf_token %}
  <textarea
    name="content"
    class="fan-wall-input"
    placeholder="Write your message to the community..."
    rows="3"
    required
  ></textarea>
  <button type="submit" class="fan-wall-btn">Post Message</button>
</form>

  <div class="fan-wall-posts">
    {% for message in fan_messages %}
      <div class="fan-post">
        <strong class="fan-author">{{ message.user.nickname|default:message.user.username }}</strong>
        <span class="fan-text">{{ message.content }}</span>
        <span class="fan-timestamp">{{ message.timestamp|timesince }} ago</span>
      </div>
    {% empty %}
      <p class="no-posts">Be a part of the CRICARENA community!!</p>
    {% endfor %}
  </div>
</section>

  </main>
</div>
<!-- Edit Profile Modal -->
<div id="editModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <h2>Edit Profile</h2>
    <form id="editProfileForm" method="POST" enctype="multipart/form-data" action="{% url 'edit_profile' %}">
      {% csrf_token %}
      <label for="nickname">Nickname</label>
      <input type="text" name="nickname" id="nickname" value="{{ user.nickname|default:user.username }}" required>

      <label for="email">Email</label>
      <input type="email" name="email" id="email" value="{{ user.email }}" required>

      <label for="avatar">Avatar (optional)</label>
      <input style="cursor: pointer;" type="file" name="avatar" id="avatar">

      {% if user.avatar %}
  <button type="submit" name="remove_avatar" value="1" class="remove-avatar-btn">
    Remove Avatar
  </button>
{% endif %}

      <div class="modal-actions">
        <button type="submit" class="modal-save-btn">Save</button>
        <button type="button" onclick="toggleModal()" class="modal-cancel-btn">Cancel</button>
      </div>
    </form>
  </div>
</div>
 <div id="page-loader" class="hide"> <!-- start hidden off-screen right -->
  <div class="loader-content">
    <div class="logo-container">
      <img src="/static/ipl/assets/cricarenalogo.png" alt="CRICARENA Logo" class="loader-logo">

      <div class="orbit orbit1"><div class="orbit-ball"></div></div>
      <div class="orbit orbit2"><div class="orbit-ball"></div></div>
      <div class="orbit orbit3"><div class="orbit-ball"></div></div>
      <div class="orbit orbit4"><div class="orbit-ball"></div></div>
      <div class="orbit orbit5"><div class="orbit-ball"></div></div>
      <div class="orbit orbit6"><div class="orbit-ball"></div></div>
    </div>

    <div class="loader-text">Loading <span id="next-page-name">...</span></div>
  </div>
</div>
 <script>
  document.documentElement.classList.add("js-loader-ready");
</script>
  <script>
    function clearBack() {
    fetch('/clear-back-url/');
  }
    function toggleModal() {
    const modal = document.getElementById("editModal");
    modal.style.display = (modal.style.display === "flex") ? "none" : "flex";
  }
  setTimeout(() => {
    const toasts = document.querySelectorAll('.toast-message');
    toasts.forEach(t => t.remove());
  }, 4000);
  const loader = document.getElementById("page-loader");
const nextPageName = document.getElementById("next-page-name");

// Mark page as JS-ready so CSS flex works
document.documentElement.classList.add("js-loader-ready");

// Handle link clicks for forward navigation
document.querySelectorAll("a").forEach(link => {
  if (link.hasAttribute("data-skip-loader")) return;
  if (
    link.hostname === window.location.hostname &&
    link.getAttribute("href") &&
    !link.href.includes("#")
  ) {
    link.addEventListener("click", e => {
      if (e.ctrlKey || e.metaKey || link.target === "_blank") return;

      e.preventDefault();

      // Set loading page name
      const pageName = link.getAttribute("data-page") || link.textContent.trim() || "Loading";
      nextPageName.textContent = pageName;

      // Show loader animation
      loader.classList.remove("hide");
      loader.classList.add("active");

      // Navigate after short delay
      setTimeout(() => {
        window.location.href = link.href;
      }, 500);
    });
  }
});

// On page load
window.addEventListener("load", () => {
  setTimeout(() => {
    loader.classList.add("hide");
    loader.classList.remove("active");
  }, 300);
});

// Detect browser back/forward and disable animation
window.addEventListener("pageshow", (event) => {
  if (
    event.persisted ||
    performance.getEntriesByType("navigation")[0]?.type === "back_forward"
  ) {
    loader.style.transition = "none"; // kill animation
    loader.classList.add("hide");
    loader.classList.remove("active");
    // Restore animation for future forward nav
    requestAnimationFrame(() => {
      loader.style.transition = "";
    });
  }
});

  </script>
</body>

</html>